version: 0.11.0.{build}

image:
  - Visual Studio 2015
  - Visual Studio 2017

assembly_info:
  patch: true
  file: AssemblyInfo.*
  assembly_version: "{version}"
  assembly_file_version: "{version}"
  assembly_informational_version: "{version}"

clone_script:
  - cmd: git clone -q --recursive --branch=%APPVEYOR_REPO_BRANCH% https://github.com/%APPVEYOR_REPO_NAME%.git %APPVEYOR_BUILD_FOLDER%
  - cmd: git checkout -qf %APPVEYOR_REPO_COMMIT%

build_script:
  # Generate a NuGet package version number.
  - echo %APPVEYOR_REPO_TAG%
  - C:\Python34\python.exe CI\version-number.py > PKG_VERSION.txt
  - Set /P PKG_VERSION=<PKG_VERSION.txt
  - echo %PKG_VERSION%

  # Get the C# compiler's path and put it in an environment variable.
  - where csc > csc-address.txt
  - set /p CSC_PATH=<csc-address.txt
  - echo %CSC_PATH%
  # Restore NuGet packages.
  - nuget restore Flame.sln
  # Build supporting macros.
  - msbuild /p:Configuration=Release /verbosity:quiet /nologo FlameMacros/FlameMacros.csproj
  # Compile macro applications.
  - C:\cygwin\bin\make dsl RUN_EXE=""
  # Build Flame.
  - msbuild /p:Configuration=Release /verbosity:quiet /nologo Flame.sln
  # Run the tests.
  - UnitTests\bin\Release\UnitTests.exe all "--csc-path=%CSC_PATH%"

after_build:
  # Create NuGet packages
  - nuget pack -Version %PKG_VERSION% Flame.nuspec
